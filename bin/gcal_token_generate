#!/bin/bash
jwt=$(h='{"alg":"RS256","typ":"JWT"}'; s="https://www.googleapis.com/auth/calendar"; f=~/.gcal_token_eh; iat=$(date +%s); exp=$((iat+3600)); email=$(jq -r .client_email $f); key=$(jq -r .private_key $f); hdr=$(echo -n $h | openssl base64 -A | tr '+/' '-_' | tr -d '='); claims=$(jq -nc --arg iss "$email" --arg scope "$s" --arg aud "https://oauth2.googleapis.com/token" --argjson iat $iat --argjson exp $exp '{iss:$iss,scope:$scope,aud:$aud,exp:$exp,iat:$iat}' | openssl base64 -A | tr '+/' '-_' | tr -d '='); sig=$(echo -n "$hdr.$claims" | openssl dgst -sha256 -sign <(jq -r .private_key $f | sed 's/\\n/\n/g') | openssl base64 -A | tr '+/' '-_' | tr -d '='); echo "$hdr.$claims.$sig"); curl -s -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=$jwt" https://oauth2.googleapis.com/token | jq -r .access_token
