#!/usr/bin/perl
use warnings;
use strict;
use feature ':5.14';

use Getopt::Long;
my %opts;
Getopt::Long::Configure('bundling');
GetOptions(
    'o|org=i'       => \$opts{org},
    'M|module=s'    => \@{$opts{modules}}
);

use Data::Dumper; $Data::Dumper::Sortkeys=1;

my @args = ('sudo', "PERL5LIB=/usr/lib/shiftboard:$ENV{PERL5LIB}", $^X, '-MSB2::Logger', '-MSB');
for my $m (@{$opts{modules}}) {
    push @args, "-M$m";
}

push @args, '-MData::Dumper', '-E', '$Data::Dumper::Sortkeys=1; $cm::BATCH_ERROR = 1;';
if ($opts{org}) {
    push @args, '-E', "\$cm::SS = $opts{org}; &cm::conf_shiftboard(\$cm::SS);";
}

my $input;
for my $arg (@ARGV) {
    if ($arg eq '-') {
        $input = 1;
    }
    elsif ($input == 1) {
        push @args, '-E', "do q{$arg}; die \$@ if \$@;";
        $input = 2;
    }
    elsif ($input == 2) {
        push @args, $arg;
    }
    else {
        push @args, '-E', $arg;
    }
}

say '# ', join ' ', map {
    (my $foo = $_) =~ s/'/'\\''/g;
    $foo =~ /[#; \t\n'"]/ ? "'$foo'" : $foo
} @args;
system(@args);

