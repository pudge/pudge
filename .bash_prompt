function set_ps1 {
    . $HOME/.git-prompt.sh
    export GIT_PS1_SHOWSTASHSTATE=1
    export GIT_PS1_SHOWDIRTYSTATE=1
    export GIT_PS1_SHOWUNTRACKEDFILES=1
    export GIT_PS1_SHOWUPSTREAM='auto'
    export GIT_PS1_HIDE_IF_PWD_IGNORED=1
    export GIT_PS1_SHOWCOLORHINTS=1
    #export GIT_PS1_STATESEPARATOR='~'
    export GIT_PS1_DESCRIBE_STYLE=branch

    local ptime puser phost phist ppwd pgit pchar
    local black red green yellow blue magenta cyan white end
    black='\[\e[30m\]'
    red='\[\e[31m\]'
    green='\[\e[32m\]'
    yellow='\[\e[33m\]'
    blue='\[\e[34m\]'
    magenta='\[\e[35m\]'
    cyan='\[\e[36m\]'
    white='\[\e[37m\]'
    end='\[\e[0m\]'

    ptime="${cyan}$(date +'%a %Y-%m-%dT%H:%M:%S')${end} "
    puser='\u'
    phost=$(hostname -f | cut -d . -f 1,2)
    if [[ $phost == 'chris-nandor' ]]; then
        phost=williams
    fi
    phist="${yellow}\!${end} "
    ppwd="${magenta}\w${end}"
    ppwdd="${magenta}\$(basename \w)${end}"
    #pgit="${red}"'$(__git_ps1 " (%s)")'"${end}"
    #pgit='$(__git_ps1 " (%s)")'
    #pchar="${blue}→${end}"
    pchar="${blue}\$${end}"

    precmd="\n\$(iterm2_prompt_mark)$ptime$puser@$phost:$ppwd"
    precmdd="$ppwd"
    postcmd="\n$phist\$(_track_time_prompt)$pchar " #" $yellow\$(get_err)$end$pchar "
    postcmdd=" $pchar "
    #export PS1="$precmd$pgit$postcmd"
    #export DEMO_PS1="${magenta}\$(basename \w)${end}$pgit \$ "

    local wintitle0='$( if [[ $ITERM_SESSION_ID && ($PWD =~ "$HOME/src/shiftboard/") ]]; then echo -n "${PWD/#$HOME\/src\/shiftboard\//}"; else echo -n "${USER}@${HOSTNAME%.*.*}:${PWD/#$HOME/~}"; fi )'
    export wintitle="echo -ne \"\033];$wintitle0: \007\""
    export PROMPT_COMMAND="history -a; __git_ps1 '$precmd' '$postcmd'; $wintitle"
    export DEMO_PROMPT_COMMAND="history -a; __git_ps1 '$precmdd' '$postcmdd'; $wintitle"
}

function _track_time_prompt {
    if [[ -s "$HOME/.sb_track_time" ]]; then
        echo -n '⏱ ';
        #echo -e ' \033[5m⏱\033[0m ';
    fi
}

function get_err {
    local err=$?
    # 130 == SIGINT
    if [[ $err != 0 && $err != 130 ]]; then
        echo -n "$err "
    fi
}

source ~/.git-prompt.bash
set_ps1
