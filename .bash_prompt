function set_ps1 {
    . $HOME/.git-prompt.sh
    export GIT_PS1_SHOWSTASHSTATE=1
    export GIT_PS1_SHOWDIRTYSTATE=1
    export GIT_PS1_SHOWUNTRACKEDFILES=1
    export GIT_PS1_SHOWUPSTREAM='auto'
    export GIT_PS1_HIDE_IF_PWD_IGNORED=1
    export GIT_PS1_SHOWCOLORHINTS=1
    #export GIT_PS1_STATESEPARATOR='~'
    export GIT_PS1_DESCRIBE_STYLE=branch

    local ptime puser phost phist ppwd pgit pchar
    local black red green yellow blue magenta cyan white end
    black='\[\e[30m\]'
    red='\[\e[31m\]'
    green='\[\e[32m\]'
    yellow='\[\e[33m\]'
    blue='\[\e[34m\]'
    magenta='\[\e[35m\]'
    cyan='\[\e[36m\]'
    white='\[\e[37m\]'
    end='\[\e[0m\]'

    ptime="${cyan}\$(_my_date)${end} "
    puser='\u'
    phost=$(hostname -f | cut -d . -f 1,2)
    if [[ $phost == 'chris-nandor' ]]; then
        phost=williams
    fi
    phist="${yellow}\!${end}"
    ppwd="${magenta}\w${end}"
    ppwdd="${magenta}\$(basename \w)${end}"
    #pgit="${red}"'$(__git_ps1 " (%s)")'"${end}"
    #pgit='$(__git_ps1 " (%s)")'
    #pchar="${blue}‚Üí${end}"
    pchar="${blue}\$${end}"

    hostmarks="$red$(_host_marks)$end"
    precmd="\n\[\$(iterm2_prompt_mark)\]$hostmarks$ptime$puser@$phost:$ppwd\$(_dyn_marks)\n$hostmarks$phist"
    precmdd="$ppwd"
    postcmd=" $pchar " #" $yellow\$(get_err)$end$pchar "
    postcmdd=" $pchar "
    #export PS1="$precmd$pgit$postcmd"
    #export DEMO_PS1="${magenta}\$(basename \w)${end}$pgit \$ "

    local wintitle0='$( if [[ $ITERM_SESSION_ID && ($PWD =~ "$HOME/src/shiftboard/") ]]; then echo -n "${PWD/#$HOME\/src\/shiftboard\//}"; else echo -n "${USER}@${HOSTNAME%.*.*}:${PWD/#$HOME/~}"; fi )'
    export wintitle="echo -ne \"\033];$wintitle0: \007\""
    export PROMPT_COMMAND="history -a; __git_ps1 '$precmd' '$postcmd'; $wintitle"
    export DEMO_PROMPT_COMMAND="history -a; __git_ps1 '$precmdd' '$postcmdd'; $wintitle"
}

function _my_date {
    date +'%a %Y-%m-%dT%H:%M:%S'
}

function _dyn_marks {
    if [[ -s "$HOME/.sb_track_time" ]]; then
        echo -n ' ‚è± ';
    fi
}

function iterm2_prompt_mark {
    echo -n ''
}

function _host_marks {
    local hostf=$(hostname -f)
    if [[ $hostf =~ \.shiftboard\.com$ ]]; then
        echo -n ' '
        if [[ $hostf =~ \.stg\.shiftboard\.com$ ]]; then
            echo -n 'üÖ¢ üÖ£ üÖñ'; # $STG
        else
            echo -n 'üÖü üÖ° üÖû üÖì'; # PROD
        fi
        echo -n ' ‚ò¢Ô∏è  '
    fi
}

function get_err {
    local err=$?
    # 130 == SIGINT
    if [[ $err != 0 && $err != 130 ]]; then
        echo -n "$err "
    fi
}

source ~/.git-prompt.bash
set_ps1
